<section class="liquid-glass rounded-3xl px-5 py-8 mb-6">
  <p class="text-[11px] uppercase tracking-[0.28em] text-slate-500">SpendLess Quest</p>
  <h1 class="text-2xl sm:text-[1.75rem] font-semibold tracking-tight mt-2">Verified coupons. Faster savings.</h1>
  <p class="text-sm mt-3 text-slate-600 max-w-2xl">Find community tested promo codes and deals in one place. Pick a brand &amp; grab a discount!</p>
  <a id="featured-offer" href="#" class="mt-4 block rounded-2xl liquid-glass px-4 py-3 border border-emerald-200/60 transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg hover:border-emerald-300/90">
    <p class="text-[11px] uppercase tracking-[0.18em] text-emerald-700/80">Featured discount</p>
    <div class="mt-1 flex items-center justify-between gap-3">
      <div>
        <p id="featured-offer-title" class="text-xs sm:text-sm font-semibold leading-tight">Loading offer…</p>
        <p id="featured-offer-subtitle" class="text-[11px] text-slate-600">View full offer ↗</p>
      </div>
      <span id="featured-offer-badge" class="text-[11px] font-semibold px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Deal</span>
    </div>
  </a>
</section>

<div class="mb-6 liquid-glass rounded-2xl p-3">
  <label for="brand-search" class="sr-only">Search brands</label>
  <input id="brand-search" type="search" placeholder="Search brands" class="w-full rounded-xl border border-slate-300/60 bg-white/70 py-3 px-4 text-sm" autocomplete="off">
  <p id="brand-search-helper" class="text-xs text-slate-500 mt-2">Showing <span id="brand-visible-count">0</span> brands</p>
</div>

<ul id="brand-grid" class="grid gap-3 sm:grid-cols-2">
  {% assign sorted_brands = site.brands | sort: "title" %}
  {% for brand in sorted_brands %}
    {% assign logo_path = brand.logo_path | default: '/media/brand_logos/' | append: brand.brand_slug | append: '.jpg' %}
    <li data-brand-card data-brand-name="{{ brand.title | downcase }}">
      <a href="{{ brand.url | relative_url }}" data-surface-card class="block liquid-glass rounded-2xl px-3 py-3">
        <div class="flex items-start gap-3">
          <div class="w-12 h-12 flex items-center justify-center rounded-xl border border-slate-200 bg-white/80 overflow-hidden">
            <img src="{{ logo_path | relative_url }}" alt="{{ brand.title }} logo" class="w-full h-full object-cover" loading="lazy">
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between gap-2">
              <span class="font-medium text-sm">{{ brand.title | replace: ' discount codes', '' | strip }}</span>
              <span data-date-chip data-date-key="brand-{{ brand.brand_slug }}" class="text-[11px] text-slate-600 inline-flex items-center gap-1 cursor-help" tabindex="0" aria-label="Recently updated">
                <svg aria-hidden="true" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="17" rx="2"></rect><path d="M8 2v4"></path><path d="M16 2v4"></path><path d="M3 10h18"></path></svg>
                <span class="sr-only">Recent date</span>
              </span>
            </div>
            <p class="text-xs text-slate-500 mt-1">{{ site.coupons | where: "brand_slug", brand.brand_slug | size }} discount codes available · Browse coupons ↗</p>
          </div>
        </div>
      </a>
    </li>
  {% endfor %}
</ul>

<div id="brand-empty-state" class="hidden text-center py-12"><p class="text-sm text-slate-500">No brands found.</p></div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('brand-search');
    const cards = Array.from(document.querySelectorAll('[data-brand-card]'));
    const grid = document.getElementById('brand-grid');
    const emptyState = document.getElementById('brand-empty-state');
    const visibleCount = document.getElementById('brand-visible-count');

    function filterBrands() {
      const query = searchInput.value.trim().toLowerCase();
      let matches = 0;
      cards.forEach((card) => {
        const ok = card.dataset.brandName.includes(query);
        card.classList.toggle('hidden', !ok);
        matches += ok ? 1 : 0;
      });
      visibleCount.textContent = matches;
      emptyState.classList.toggle('hidden', matches !== 0);
      grid.classList.toggle('hidden', matches === 0);
    }

    filterBrands();
    searchInput.addEventListener('input', filterBrands);

    const featureLink = document.getElementById('featured-offer');
    const featureTitle = document.getElementById('featured-offer-title');
    const featureSubtitle = document.getElementById('featured-offer-subtitle');
    const featureBadge = document.getElementById('featured-offer-badge');
    const allOffers = [
      {% for coupon in site.coupons %}
        {
          url: {{ coupon.url | relative_url | jsonify }},
          title: {{ coupon.title | jsonify }},
          discount: {{ coupon.discount_value | default: 'Hot deal' | jsonify }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    if (featureLink && allOffers.length) {
      const picked = allOffers[Math.floor(Math.random() * allOffers.length)];
      featureLink.href = picked.url;
      featureTitle.textContent = picked.title;
      featureSubtitle.textContent = 'View full offer ↗';
      featureBadge.textContent = picked.discount;
    }

    const dateStorageKey = 'spendless-random-dates-v1';
    const today = new Date();
    const weekdays = { weekday: 'short', month: 'short', day: 'numeric' };
    const randomDateForKey = (key, cache) => {
      if (!cache[key]) {
        const offset = Math.floor(Math.random() * 7);
        const d = new Date(today);
        d.setDate(today.getDate() - offset);
        cache[key] = d.toISOString();
      }
      return new Date(cache[key]);
    };

    let dateCache = {};
    try { dateCache = JSON.parse(localStorage.getItem(dateStorageKey) || '{}') || {}; }
    catch (_) { dateCache = {}; }

    document.querySelectorAll('[data-date-chip]').forEach((el) => {
      const key = el.getAttribute('data-date-key');
      if (!key) return;
      const date = randomDateForKey(key, dateCache);
      const label = date.toLocaleDateString(undefined, weekdays);
      el.title = `Added ${label}`;
      el.setAttribute('aria-label', `Added ${label}`);
    });

    localStorage.setItem(dateStorageKey, JSON.stringify(dateCache));
  });
</script>
