<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title }} | {{ site.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    {% assign meta_description = page.description | default: page.description_short | default: site.description %}
    <meta name="description" content="{{ meta_description }}">

    <link rel="apple-touch-icon" sizes="180x180" href="{{ '/media/apple-touch-icon.png' | relative_url }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ '/media/favicon-32x32.png' | relative_url }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ '/media/favicon-16x16.png' | relative_url }}">
    <link rel="shortcut icon" href="{{ '/media/favicon.ico' | relative_url }}">
    <meta name="theme-color" content="#dbeafe">

    <meta property="og:title" content="{{ page.title }} | {{ site.title }}">
    <meta property="og:description" content="{{ meta_description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ page.url | relative_url | absolute_url }}">
    <meta property="og:image" content="{{ '/media/og-card-1200x630.png' | absolute_url }}">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ page.title }} | {{ site.title }}">
    <meta name="twitter:description" content="{{ meta_description }}">
    <meta name="twitter:image" content="{{ '/media/twitter-card-1200x675.png' | absolute_url }}">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --bg: #e2e8f0;
        --text: #0f172a;
        --glass: rgba(255, 255, 255, 0.54);
        --glass-strong: rgba(255, 255, 255, 0.72);
        --line: rgba(148, 163, 184, 0.35);
        --accent: #2563eb;
      }

      body {
        background:
          radial-gradient(circle at 5% 0%, #bfdbfe 0%, transparent 45%),
          radial-gradient(circle at 95% 10%, #c4b5fd 0%, transparent 40%),
          linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
        color: var(--text);
      }

      body.dark {
        --bg: #020617;
        --text: #f8fafc;
        --glass: rgba(15, 23, 42, 0.55);
        --glass-strong: rgba(15, 23, 42, 0.72);
        --line: rgba(71, 85, 105, 0.55);
        --accent: #38bdf8;
        background:
          radial-gradient(circle at 5% 0%, rgba(30, 41, 59, 0.8) 0%, transparent 45%),
          radial-gradient(circle at 95% 10%, rgba(49, 46, 129, 0.45) 0%, transparent 40%),
          linear-gradient(180deg, #020617 0%, #0f172a 100%);
      }

      .liquid-glass {
        background: var(--glass);
        border: 1px solid var(--line);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), 0 12px 40px rgba(15, 23, 42, 0.12);
        backdrop-filter: blur(18px) saturate(150%);
      }

      .liquid-glass-strong {
        background: var(--glass-strong);
        border: 1px solid var(--line);
        backdrop-filter: blur(24px) saturate(170%);
      }

      [data-surface-card] {
        transition: transform .22s ease, border-color .22s ease, box-shadow .22s ease;
      }

      [data-surface-card]:hover {
        transform: translateY(-2px) scale(1.01);
      }

      .xp-shell {
        position: relative;
        overflow: hidden;
      }

      .xp-shell::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, transparent 25%, rgba(255, 255, 255, 0.35) 50%, transparent 75%);
        transform: translateX(-120%);
        animation: xpShine 2.4s ease-in-out infinite;
        pointer-events: none;
      }

      #xp-progress {
        transition: width .45s ease;
      }

      @keyframes xpShine {
        0%, 85%, 100% { transform: translateX(-120%); }
        45% { transform: translateX(120%); }
      }

      @media (max-width: 640px) {
        [data-mobile-enter] {
          animation: mobileEnter .35s ease both;
        }

        @keyframes mobileEnter {
          from { opacity: 0; transform: translateY(12px); }
          to { opacity: 1; transform: translateY(0); }
        }
      }
    </style>
  </head>
  <body class="min-h-screen transition-colors duration-300 flex flex-col pb-safe">
    <header class="sticky top-2 z-20 px-3">
      <div class="max-w-4xl mx-auto mt-2 rounded-2xl liquid-glass-strong">
        <div class="px-4 py-3 flex items-center justify-between gap-2 sm:gap-3">
          <a href="{{ '/' | relative_url }}" class="text-sm font-semibold tracking-tight flex items-center gap-2 min-w-0">
            <img src="{{ '/media/piggy.png' | relative_url }}" alt="SpendLess logo" class="h-8 w-8 rounded-lg">
            <span class="leading-none">
              <span class="block text-[1.85rem] sm:text-3xl font-bold">SpendLess</span>
              <span class="block -mt-1 text-[10px] tracking-[0.14em] uppercase opacity-55">Offers</span>
            </span>
          </a>
          <nav class="text-xs flex items-center gap-1.5 sm:gap-2 shrink-0">
            <button id="xp-panel" type="button" class="xp-shell rounded-xl px-2 py-1 liquid-glass w-[145px] sm:w-[180px] text-left" aria-label="XP progress. Collect more offers to unlock exclusive deals">
              <div class="flex items-center justify-between gap-2 text-[11px] font-semibold">
                <span id="scoreboard">XP 0</span>
                <span id="levelboard" class="text-slate-500">Lv. 1</span>
              </div>
              <div class="mt-1 h-1.5 rounded-full bg-slate-300/50 overflow-hidden">
                <div id="xp-progress" class="h-full bg-blue-500/80" style="width:0%"></div>
              </div>
            </button>
            <button id="theme-toggle" type="button" aria-label="Toggle dark mode" class="rounded-full border w-10 h-10 flex items-center justify-center text-lg font-semibold liquid-glass">
              <span id="theme-toggle-icon" aria-hidden="true">ðŸŒ™</span>
            </button>
          </nav>
        </div>
      </div>
    </header>

    <main data-mobile-enter class="max-w-4xl mx-auto px-4 py-6 flex-1 w-full">
      {{ content }}
    </main>

    <footer class="px-3 pb-4">
      <div class="max-w-4xl mx-auto rounded-2xl liquid-glass px-4 py-5 text-xs text-slate-600 dark:text-slate-300">
        &copy; {{ site.time | date: "%Y" }} SpendLess Â· feed inspired by
        <a href="https://reddit.com/r/SpendLess" class="underline" target="_blank" rel="noopener">/r/SpendLess</a>
      </div>
    </footer>

    <script>
      (function () {
        const body = document.body;
        const toggleButton = document.getElementById('theme-toggle');
        const toggleIcon = document.getElementById('theme-toggle-icon');
        const storageKey = 'spendless-theme';
        const scoreEl = document.getElementById('scoreboard');
        const levelEl = document.getElementById('levelboard');
        const progressEl = document.getElementById('xp-progress');

        const storedTheme = localStorage.getItem(storageKey);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(storedTheme || (prefersDark ? 'dark' : 'light'));

        toggleButton?.addEventListener('click', function () {
          applyTheme(body.classList.contains('dark') ? 'light' : 'dark');
        });

        function applyTheme(theme) {
          const isDark = theme === 'dark';
          body.classList.toggle('dark', isDark);
          localStorage.setItem(storageKey, theme);
          if (toggleIcon) toggleIcon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        }

        function renderScore() {
          const score = parseInt(localStorage.getItem('sl_score') || '0', 10);
          const level = Math.floor(score / 100) + 1;
          const progress = score % 100;
          if (scoreEl) scoreEl.textContent = `XP ${score}`;
          if (levelEl) levelEl.textContent = `Lv. ${level}`;
          if (progressEl) progressEl.style.width = `${progress}%`;
        }

        window.updateScore = function (amount) {
          const next = parseInt(localStorage.getItem('sl_score') || '0', 10) + (amount || 1);
          localStorage.setItem('sl_score', next);
          renderScore();
        };

        renderScore();

        const xpPanel = document.getElementById('xp-panel');
        const xpMessage = 'Collect more offers to unlock exclusive deals';
        if (xpPanel) {
          xpPanel.title = xpMessage;
          const announce = () => {
            xpPanel.setAttribute('aria-label', `XP progress. ${xpMessage}`);
          };
          xpPanel.addEventListener('mouseenter', announce);
          xpPanel.addEventListener('click', announce);
          xpPanel.addEventListener('touchstart', announce, { passive: true });
        }

        if ('startViewTransition' in document && window.matchMedia('(max-width: 640px)').matches) {
          document.querySelectorAll('a[href]').forEach((link) => {
            link.addEventListener('click', (event) => {
              const href = link.getAttribute('href');
              if (!href || href.startsWith('#') || link.target === '_blank' || event.metaKey || event.ctrlKey) return;
              event.preventDefault();
              document.startViewTransition(() => {
                window.location.href = href;
              });
            });
          });
        }

        const storageKeyReported = 'spendless-reported-coupons';
        const reportedLabel = 'Reported, thanks';
        const defaultLabel = 'Report invalid code';

        const loadReported = () => {
          try {
            const stored = JSON.parse(localStorage.getItem(storageKeyReported) || '[]');
            return Array.isArray(stored) ? new Set(stored) : new Set();
          } catch (_) { return new Set(); }
        };

        const persistReported = (set) => localStorage.setItem(storageKeyReported, JSON.stringify(Array.from(set)));

        document.querySelectorAll('[data-report-invalid]').forEach((button) => {
          const couponId = button.getAttribute('data-coupon-id');
          if (!couponId) return;
          const reported = loadReported();
          const paint = () => {
            const yes = reported.has(couponId);
            button.textContent = yes ? reportedLabel : defaultLabel;
          };
          paint();
          button.addEventListener('click', (event) => {
            event.preventDefault();
            reported.add(couponId);
            persistReported(reported);
            paint();
          });
        });
      })();
    </script>
  </body>
</html>
